apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  labels:
    app: init-demo
data:
  app.properties: |
    app.name=DaemonSet App
    app.version=1.0
    log.level=INFO
  database.url: "http://database.default.svc.cluster.local:5432"
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: app-init-demo
  labels:
    app: init-demo
    exercise: ex4
spec:
  selector:
    matchLabels:
      app: init-demo
  template:
    metadata:
      labels:
        app: init-demo
    spec:
      initContainers:
      # Init 1: Wait for ConfigMap to be mounted
      - name: wait-for-config
        image: busybox
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for configuration to be available..."
          until [ -f /config/app.properties ]; do
            echo "Config not ready, waiting..."
            sleep 2
          done
          echo "Configuration found!"
          cat /config/app.properties
        volumeMounts:
        - name: config
          mountPath: /config

      # Init 2: Download additional configuration
      - name: download-config
        image: busybox
        command: ['sh', '-c']
        args:
        - |
          echo "Downloading runtime configuration..."
          cat > /runtime-config/runtime.conf <<EOF
          NODE_NAME=${NODE_NAME}
          POD_NAME=${POD_NAME}
          POD_IP=${POD_IP}
          TIMESTAMP=$(date)
          EOF
          echo "Runtime configuration created:"
          cat /runtime-config/runtime.conf
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: runtime-config
          mountPath: /runtime-config

      # Init 3: Setup data directories
      - name: setup-directories
        image: busybox
        command: ['sh', '-c']
        args:
        - |
          echo "Setting up data directories..."
          mkdir -p /data/logs /data/cache /data/tmp
          chmod 755 /data/logs /data/cache /data/tmp
          echo "Directories created successfully:"
          ls -la /data/
        volumeMounts:
        - name: data
          mountPath: /data

      containers:
      - name: app
        image: busybox
        command: ['sh', '-c']
        args:
        - |
          echo "=== Application Starting ==="
          echo ""
          echo "Configuration from ConfigMap:"
          cat /etc/config/app.properties
          echo ""
          echo "Runtime configuration:"
          cat /etc/runtime/runtime.conf
          echo ""
          echo "Data directories:"
          ls -la /var/app/data
          echo ""
          echo "Application running on ${NODE_NAME}"

          # Write logs
          while true; do
            echo "$(date): Application running" >> /var/app/data/logs/app.log
            tail -5 /var/app/data/logs/app.log
            sleep 30
          done
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: config
          mountPath: /etc/config
          readOnly: true
        - name: runtime-config
          mountPath: /etc/runtime
          readOnly: true
        - name: data
          mountPath: /var/app/data
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"

      volumes:
      - name: config
        configMap:
          name: app-config
      - name: runtime-config
        emptyDir: {}
      - name: data
        emptyDir: {}
