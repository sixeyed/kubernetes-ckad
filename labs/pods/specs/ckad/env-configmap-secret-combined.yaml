apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config-combined
  labels:
    kubernetes.courselabs.co: pods
data:
  app_name: "my-application"
  environment: "production"
  log_level: "info"
  database_host: "postgres.default.svc.cluster.local"
  database_port: "5432"
  database_name: "myapp"
  redis_host: "redis.default.svc.cluster.local"
  redis_port: "6379"
---
apiVersion: v1
kind: Secret
metadata:
  name: app-secret-combined
  labels:
    kubernetes.courselabs.co: pods
type: Opaque
stringData:
  database_username: "appuser"
  database_password: "SecureP@ss123"
  redis_password: "RedisP@ss456"
  jwt_secret: "my-jwt-secret-key-do-not-share"
---
apiVersion: v1
kind: Pod
metadata:
  name: app-with-config-and-secrets
  labels:
    app: production-app
    kubernetes.courselabs.co: pods
spec:
  containers:
  - name: app
    image: busybox:latest
    command:
    - sh
    - -c
    - |
      echo "=== Application Configuration ==="
      echo "App Name: $APP_NAME"
      echo "Environment: $ENVIRONMENT"
      echo "Log Level: $LOG_LEVEL"
      echo ""
      echo "=== Database Configuration ==="
      echo "Host: $DB_HOST"
      echo "Port: $DB_PORT"
      echo "Database: $DB_NAME"
      echo "Username: $DB_USER"
      echo "Password: [REDACTED]"
      echo ""
      echo "=== Redis Configuration ==="
      echo "Host: $REDIS_HOST"
      echo "Port: $REDIS_PORT"
      echo "Password: [REDACTED]"
      echo ""
      echo "=== Security ==="
      echo "JWT Secret: [REDACTED]"
      echo ""
      echo "Application ready to connect to services!"
      sleep 3600
    env:
    # Individual values from ConfigMap
    - name: APP_NAME
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: app_name
    - name: ENVIRONMENT
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: environment
    - name: LOG_LEVEL
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: log_level

    # Database config from ConfigMap and Secret
    - name: DB_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: database_host
    - name: DB_PORT
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: database_port
    - name: DB_NAME
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: database_name
    - name: DB_USER
      valueFrom:
        secretKeyRef:
          name: app-secret-combined
          key: database_username
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: app-secret-combined
          key: database_password

    # Redis config from ConfigMap and Secret
    - name: REDIS_HOST
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: redis_host
    - name: REDIS_PORT
      valueFrom:
        configMapKeyRef:
          name: app-config-combined
          key: redis_port
    - name: REDIS_PASSWORD
      valueFrom:
        secretKeyRef:
          name: app-secret-combined
          key: redis_password

    # JWT secret
    - name: JWT_SECRET
      valueFrom:
        secretKeyRef:
          name: app-secret-combined
          key: jwt_secret
---
# Alternative approach using envFrom
apiVersion: v1
kind: Pod
metadata:
  name: app-with-envfrom
  labels:
    app: production-app-envfrom
    kubernetes.courselabs.co: pods
spec:
  containers:
  - name: app
    image: busybox:latest
    command:
    - sh
    - -c
    - |
      echo "=== All Environment Variables ==="
      env | sort | grep -v "KUBERNETES_\|HOSTNAME\|HOME\|PATH"
      sleep 3600
    envFrom:
    # Load all ConfigMap keys as env vars
    - configMapRef:
        name: app-config-combined
    # Load all Secret keys as env vars
    - secretRef:
        name: app-secret-combined
    # Can also add prefix to avoid conflicts
    env:
    - name: CUSTOM_VALUE
      value: "hardcoded-value"
