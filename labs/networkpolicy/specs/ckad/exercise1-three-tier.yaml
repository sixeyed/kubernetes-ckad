# Exercise 1: Complete Three-Tier Application with NetworkPolicy
#
# This demonstrates a complete three-tier architecture with comprehensive
# network policies implementing defense-in-depth security.
#
# Architecture:
# - Web tier: Public-facing, accepts HTTP traffic
# - API tier: Internal service, accessed by web tier
# - Database tier: Data layer, accessed by API tier only
# - DNS: All tiers need DNS resolution

---
# Namespace for the exercise
apiVersion: v1
kind: Namespace
metadata:
  name: three-tier
  labels:
    app: three-tier-demo

---
# Default Deny All Policy
# Start with zero trust - deny all ingress and egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: three-tier
spec:
  podSelector: {}  # Applies to all pods
  policyTypes:
  - Ingress
  - Egress

---
# Web Tier Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  namespace: three-tier
  labels:
    tier: web
spec:
  replicas: 2
  selector:
    matchLabels:
      tier: web
  template:
    metadata:
      labels:
        tier: web
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80

---
# Web Service
apiVersion: v1
kind: Service
metadata:
  name: web
  namespace: three-tier
  labels:
    tier: web
spec:
  type: NodePort
  selector:
    tier: web
  ports:
  - port: 80
    targetPort: 80

---
# Web NetworkPolicy - Ingress
# Allows incoming HTTP traffic from any source
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-ingress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: web
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}  # Allow from any pod in namespace
    ports:
    - protocol: TCP
      port: 80

---
# Web NetworkPolicy - Egress
# Allows DNS and communication to API tier
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-egress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: web
  policyTypes:
  - Egress
  egress:
  # Allow DNS (critical for service discovery)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow to API tier on port 8080
  - to:
    - podSelector:
        matchLabels:
          tier: api
    ports:
    - protocol: TCP
      port: 8080

---
# API Tier Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  namespace: three-tier
  labels:
    tier: api
spec:
  replicas: 2
  selector:
    matchLabels:
      tier: api
  template:
    metadata:
      labels:
        tier: api
    spec:
      containers:
      - name: api
        image: kiamol/ch05-pi
        ports:
        - containerPort: 8080

---
# API Service
apiVersion: v1
kind: Service
metadata:
  name: api
  namespace: three-tier
  labels:
    tier: api
spec:
  selector:
    tier: api
  ports:
  - port: 8080
    targetPort: 8080

---
# API NetworkPolicy - Ingress
# Only accepts traffic from web tier
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-ingress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: api
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: web
    ports:
    - protocol: TCP
      port: 8080

---
# API NetworkPolicy - Egress
# Allows DNS and communication to database tier
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-egress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: api
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow to database tier on port 5432
  - to:
    - podSelector:
        matchLabels:
          tier: database
    ports:
    - protocol: TCP
      port: 5432

---
# Database Tier Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: database
  namespace: three-tier
  labels:
    tier: database
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: database
  template:
    metadata:
      labels:
        tier: database
    spec:
      containers:
      - name: postgres
        image: postgres:13-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_PASSWORD
          value: "demo123"
        - name: POSTGRES_DB
          value: "appdb"

---
# Database Service
apiVersion: v1
kind: Service
metadata:
  name: database
  namespace: three-tier
  labels:
    tier: database
spec:
  selector:
    tier: database
  ports:
  - port: 5432
    targetPort: 5432

---
# Database NetworkPolicy - Ingress
# Only accepts traffic from API tier
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-ingress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: api
    ports:
    - protocol: TCP
      port: 5432

---
# Database NetworkPolicy - Egress
# Database only needs DNS (no outbound connections to other services)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-egress
  namespace: three-tier
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Egress
  egress:
  # Allow DNS only
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
